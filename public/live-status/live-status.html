<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trạng thái Realtime - SportReg</title>
    <link rel="stylesheet" href="live-status.css">
    <!-- Google Fonts: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Boxicons -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>
<body>

    <input type="checkbox" id="nav-toggle">

    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main Content -->
    <div class="main-content">
        <header>
            <h2>
                <label for="nav-toggle"><i class='bx bx-menu'></i></label>
                Trực tiếp thi đấu
            </h2>
            <div class="user-wrapper">
                <img src="" width="40px" height="40px" alt="Avatar">
                <div>
                    <h4>Loading...</h4>
                    <small>...</small>
                </div>
            </div>
        </header>

        <main>
            <div class="page-header">
                <h1>Đang diễn ra</h1>
                <div class="live-indicator">
                    <span class="blob"></span> Hệ thống Realtime đang hoạt động
                </div>
            </div>

            <!-- Grid danh sách trận đấu -->
            <div class="live-grid" id="live-matches-container">
                <p style="text-align:center; width:100%; color:#666;">Đang tải dữ liệu trực tiếp...</p>
            </div>
        </main>
    </div>

    <!-- Nhúng thư viện Socket.io -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // 1. Kết nối đến Server
        const socket = io();

        // 2. Hàm load dữ liệu ban đầu
        async function loadLiveMatches() {
            try {
                const res = await fetch('/api/matches/live');
                const matches = await res.json();
                const container = document.getElementById('live-matches-container');
                
                container.innerHTML = '';
                if (matches.length === 0) {
                    container.innerHTML = '<p style="text-align:center; width:100%;">Hiện không có trận đấu nào đang diễn ra.</p>';
                    return;
                }

                matches.forEach(m => {
                    const isLive = m.status === 'live';
                    const statusClass = isLive ? 'live' : 'upcoming';
                    const statusText = isLive ? 'LIVE' : (m.start_time ? new Date(m.start_time).toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'}) : 'Sắp đấu');
                    const activeClass = isLive ? 'live-active' : '';
                    
                    const scoreDisplay = isLive 
                        ? `<span class="score score-team1">${m.score1 || 0}</span><span class="divider">-</span><span class="score score-team2">${m.score2 || 0}</span>`
                        : `<span style="font-size:1.5rem; font-weight:bold; color:#64748b;">VS</span>`;

                    const html = `
                        <div class="match-card ${activeClass}" id="match-${m.id}">
                            <div class="card-top">
                                <div class="sport-tag"><i class='bx bx-trophy'></i> ${m.sport_type}</div>
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </div>
                            <div class="match-info">
                                <div class="team">
                                    <div class="team-logo" style="background: #3b82f6;">${m.team1.charAt(0)}</div>
                                    <span class="team-name">${m.team1}</span>
                                </div>
                                <div class="score-box">
                                    ${scoreDisplay}
                                </div>
                                <div class="team">
                                    <div class="team-logo" style="background: #ef4444;">${m.team2.charAt(0)}</div>
                                    <span class="team-name">${m.team2}</span>
                                </div>
                            </div>
                            <div class="card-footer">
                                <span><i class='bx bx-map'></i> ${m.venue || 'Chưa xếp sân'}</span>
                                <span>${m.round}</span>
                            </div>
                        </div>
                    `;
                    container.innerHTML += html;
                });
            } catch (err) {
                console.error(err);
            }
        }

        // Gọi hàm load khi trang tải xong
        loadLiveMatches();

        // 3. Lắng nghe sự kiện 'score_updated' để cập nhật Realtime
        socket.on('score_updated', (data) => {
            console.log('Nhận dữ liệu mới:', data);
            
            // Tìm thẻ HTML tương ứng với matchId
            const matchCard = document.getElementById(`match-${data.matchId}`);
            if (matchCard) {
                // Nếu thẻ đã tồn tại, reload lại toàn bộ danh sách để cập nhật đúng trạng thái/thứ tự
                loadLiveMatches();
            } else {
                // Nếu là trận mới chuyển sang live, cũng reload
                loadLiveMatches();
            }
        });
    </script>
    <!-- Script Common (Logic chung) -->
    <script src="/js/common.js"></script>
</body>
</html>